<html>

<head>
        <style>
                th.rotate 
                {
                  /* Something you can count on */
                  height: 160px;
                  white-space: nowrap;
                }
                
                th.rotate > div 
                {
                  transform: 
                    /* Magic Numbers */
                    translate(55px, 5px)
                    
                    /* 45 is really 360 - 45 */
                    rotate(315deg);
                  width: 30px;
                }
                th.rotate > div > span 
                {
                  border-bottom: 1px solid #ccc;
                  padding: 0px 30px;
                }
                </style>
                
    <meta charset="utf-8">
    <script language="javascript">

    //const basicAuth = require('./helpers/basic-auth');
    </script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

<script language="javascript">
var instID = -1;
var instructor = "";
var admin = 0;
var userName = "";
var userId = -9;

async function getUserDetails()
{    
    $.get("/userName", "", function(json)
    {
        user = JSON.parse(json);
        userId = user.id;
        userName = user.name;
        admin = user.admin;

        //alert("user ''"+userName+"'' is "+(user.admin == 1? "": "NOT an ")+"admin!");
        document.getElementById("selector").innerHTML = userName;
        if (admin == 1) loadRakazim();
        else getMembersToClient(userId);
    });
};
    
    async function loadRakazim() 
    {
        if (userName == "")
        {
            await getUserDetails(); 
        }
    
        //if (instID.length < 1)

        if (userId != -9)
        {
            instName(userId);
            //loadData(instID);
            getMembersToClient(userId);
            html = instructor;

            $("#currentUser").replaceWith(html);
        }
        else
        {
            $.get("/rakazim", "", function (json) 
            {
                try 
                {
                    var rakazimArray = JSON.parse(json);
                    loadData(rakazimArray);
                }
                catch(e)
                {
                    //alert(e);
                }
                // delete:
                //loadData(rakazimArray);
            });
        }
    }
    
    function loadData(rakazimArray)
    {
        if (admin)
        {
            //loadRakazim();

            // admin user! show ALL rakazim...
            var html = "<select id=\"rakazim\" onChange=\"getMembersToClient(this.options[this.selectedIndex].getAttribute('id'))\">";
    
            $.each(rakazimArray, function (i, value) 
            {
                html += "<option  id=\""+rakazimArray[i].id+"\" value="+rakazimArray[i].Name+"\">"+rakazimArray[i].Name+"</option>";
            });
            html += "</select>";

        }
        else
        {
            // normal user
            instName(userId);
            //loadData(userId);
            getMembersToClient(userId);
            html = "<input type=\"text\" value=\"" + instructor + "\">";

            $("#rakazim").innerHTML = html;
        }

        document.getElementById("selector").innerHTML = html;
    }

var datesArr = {};
var part;
var partByMembers = new Array();

function instName(ID)
{
    document.getElementById("instName").innerHTML = userName;
    $("#rakazim").innerHTML = userName;
}

//
// הצג את החניכים של מדריך זה בטבלת השתתפות!
//
function getMembersToClient(instID)
{
    var url = "/getParticipation?instID="+instID;
    var html = "<th class=\"straight\"><div><span></span></div></th>";

    $.get(url, "", function (json2) 
    {
        //alert(json2);
        //alert("got participation for "+instID);
        
        $.get("/getInstDates?instID="+instID, "", function (datesJson)
        {    
            dates = JSON.parse(datesJson);
            //alert("got dates for "+instID);

            // first add dates as headers
            //alert("for each one of the "+dates.length+" dates of that instructor...");
            for (k = dates.length - 1; k > -1; k--)
            {
                html += "<th class=\"rotate\"><div><span>"+dates[k].date+"</span></div></th>";
            }
            html += "<th class=\"rotate\"><div><tbody></tbody>";

            // add totals records BEFORE actual listings
            html += "<tr><td></td>";
            for (k = dates.length - 1; k > -1; k--)
            {
                var totalAmount = Number(dates[k].yes) + Number(dates[k].no);
                html += "<td style=\"border:2px solid gray;\">כמות חניכים כוללת:"  +totalAmount+ "<br> היו: <font color=\"ForestGreen\">"+dates[k].yes+"</font>\nנעדרו: <font color=\"red\">"+dates[k].no + "</font>";
            }
            html += "</tr>";

            //alert("created html:" + html);
            try 
            {
                part = JSON.parse(json2);
                //alert("understood json for /getParticipation")

                var members = new Array();
                var memberInsideAlready = new Array();

                $('#myMembers tbody tr').remove();

                //alert("compare to each of the "+part.length+" participants' dates to show participation for each...");
                for (p = 0; p < part.length; p++)
                {
                    var currName = part[p].member;
                    
                    html += "<tr><th class=\"straight\"><div><span></span></div></th>";
                
                    html += "<tr>";
                    html += "<th>"+currName+" ("+(p+1)+")</th><td></td>";

                    var columnsCount = 0;
                    // go over all available dates (table columns)
                    for (var cols = dates.length - 1; cols > -1; cols--)
                    {
                        var currDate = dates[cols];
                        var dateAvailable = false;
                        var dateIndex = -1;

                        var datesCount = dates.length;


                        // compare them to the dates returned from prticipation table to un\check them...
                        for (var dateInd = part[p].dates.length - 1; dateInd > -1; dateInd--)
                        {
                            var yaniv = 0;
                            if (part[p].dates[dateInd].date == currDate.date) 
                            {
                                dateIndex = dateInd;
                                dateAvailable = true;
                            }
                        }
                        if ( dateAvailable )
                        {
                            html += "<td><input type=\"checkbox\"";
                            html += part[p].dates[dateIndex].participated ? "checked=\"checked\"": "";
                            html += " disabled></td>"; 
                            columnsCount++;
                        } 
                        else
                        {
                            html += "<td>X</td>";
                            columnsCount++;
                        }
                    }
                    for (var missing = columnsCount; missing < datesCount; missing++)
                    {
                        //html += "<td>X</td>";
                    }

                    html += "</tr>";
                    //alert("created html for users!");
                }
                document.getElementById("myMembers").innerHTML = "<table id=\"partTable\">"+html+"</table>";    
                document.getElementById("createbutt").style.visibility = "visible";

                

            }
            catch (e)
            {
                alert("exception 8:"+e);
            }
         });
         

    });

}
function ObjNum(obj, arr)
{
    for (i = 0; i < arr.length; i++)
    {
        if (arr[i].name == obj)
            return i;
    }
    return -1;
}

function ObjInArray(obj, arr)
{
    for (i = 0; i < arr.length; i++)
    {
        if (arr[i] == obj)
            return true;
    }
    return false;
}

function createNew()
{
    if (document.getElementById("myMembers").rows.length <= 2) return;
    var sel = document.getElementById("rakazim");
    var selecteduser = sel.options[sel.selectedIndex].id;
    window.location = "./newActivity.html?instid="+selecteduser;
}
</script>
</head>
<body onload="loadRakazim()" dir="rtl">

    <h2>רישום השתתפות של חניכים של <span id="instName"></span></h2>
    <br>
    <script language="javascript">
        
    if (admin)
    {
        document.write("<h3>'<span id=\"Rakazim\">?</span>' בחר רכז:");
    }
    else
    {

    }
    </script>
    משתמש: <span id="selector">?</span>
     
         <!-- used to be:'selector-->
        <hr>
        <table border=0 id="myMembers" >
                <tbody>
                    <tr>
                        <th></th>
                    </tr>
                    <tr>
                        <td></td>
                    </tr>

                    <hr>
                    
                    <button ID="createbutt" type="button" onclick="createNew()" STYLE="visibility: hidden">צור פעולה חדשה</button>

                    
                </tbody>
            </table>
    

    <script lang="=javascript">
       </script>
</body>

</html>