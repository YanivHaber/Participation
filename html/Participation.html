<html lang='h' dir='rtl'>

<head>
        <style>
                th.rotate 
                {
                  /* Something you can count on */
                  height: 160px;
                  white-space: nowrap;
                }
                
                th.rotate > div 
                {
                  transform: 
                    /* Magic Numbers */
                    translate(55px, 5px)
                    
                    /* 45 is really 360 - 45 */
                    rotate(315deg);
                  width: 30px;
                }
                th.rotate > div > span 
                {
                  border-bottom: 1px solid #ccc;
                  padding: 0px 30px;
                }
                </style>
                
    
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

<script language="javascript">
var instID = -1;
var instructor = "";
var admin = 0;
var userName = "";
var district = "";
var userId = -9;
getUserDetails();


async function getUserDetails()
{    
    $.get("/userName", "", function(json)
    {
        user = JSON.parse(json);
        userId = user.id;
        instID = user.id;
        userName = user.name;
        admin = user.admin;
        district = user.district;

        if (admin == "1")
        {
            loadRakazim();
            document.getElementById("rakazSelector").innerHTML = "<div id=\"chooseInst\">רכז: <span id=\"selector\">?</span></div>";
            document.getElementById("RakazSelector").innerHTML = "<h3>'<span id=\"Rakazim\">(hit reload)</span>' בחר רכז:";
            document.getElementById("chooseInstructor").innerHTML = `<div id="chooseInst">רכז: <span id="selector"></span></div>`;
        }
        else
        {
            getMembersToClient(userId);
        }
        //alert("user ''"+userName+"'' is "+(user.admin == 1? "": "NOT an ")+"admin!");
        //document.getElementById("selector").innerHTML = userName;
        document.getElementById("branch").innerHTML = district;
        //document.getElementById("instNameHtml").innerHTML = userName;

    });
};
    
    async function loadRakazim() 
    {    
        //if (instID.length < 1)

        if (userId != -9)
        {
            instName(userId);
            //loadData(instID);
            getMembersToClient(userId);
            html = instructor;

            $("#currentUser").replaceWith(html);
        }
        else
        {
            $.get("/rakazim", "", function (json) 
            {
                try 
                {
                    var rakazimArray = JSON.parse(json);
                    loadData(rakazimArray);
                }
                catch(e)
                {
                    //alert(e);
                }
                // delete:
                //loadData(rakazimArray);
            });
        }
    }
    
    function loadData(rakazimArray)
    {
        if (admin == "1")
        {
            // admin user! show ALL rakazim...
            var html = "<select id=\"rakazim\" onChange=\"getMembersToClient(this.options[this.selectedIndex].getAttribute('id'))\">";
    
            $.each(rakazimArray, function (i, value) 
            {
                html += `<option id="${rakazimArray[i].id}" value="${rakazimArray[i].Name}">${rakazimArray[i].Name}</option>`;
            });
            html += "</select>";

        }
        else
        {
            // normal user
            instName(userId);
            //loadData(userId);
            getMembersToClient(userId);
            html = "<input type=\"text\" value=\"" + instructor + "\">";

            $("#rakazim").innerHTML = html;
        }

        document.getElementById("selector").innerHTML = html;

        if (admin != 1)
        {
            var elem = document.getElementById("chooseInst");
            elem.parentNode.removeChild(elem);
        }
    }

var datesArr = {};
var part;
var partByMembers = new Array();

function instName(ID)
{
    document.getElementById("instName").innerHTML = userName;
    $("#rakazim").innerHTML = userName;
}

var dates;

//
// הצג את החניכים של מדריך זה בטבלת השתתפות!
//
function getMembersToClient(instID)
{
    alert("getting members");
    var url = "/getParticipation?instID="+instID;
    var html = "<th class=\"straight\"><div><span></span></div></th>";

    $.get(url, "", function (json2) 
    {
        //alert(json2);
        //alert("got participation for "+instID);
        
        $.get("/getInstDates?instID="+instID, "", function (datesJson)
        {    
            dates = JSON.parse(datesJson);
            datesArr = dates;
            drawActivityDetails();
            //alert("got dates for "+instID);

            //drawActivityDetails();
            
            // first add dates as headers
            //alert("for each one of the "+dates.length+" dates of that instructor...");
            for (k = dates.length - 1; k > -1; k--)
            {
                html += "<th class=\"rotate\"><div><span>"+dates[k].date+"</span></div></th>";
            }
            html += "<th class=\"rotate\"><div><tbody></tbody>";

            // add totals records BEFORE actual listings
            html += "<tr><td></td>";
            for (k = dates.length - 1; k > -1; k--)
            {
                var totalAmount = Number(dates[k].yes) + Number(dates[k].no);

                html += "<td style=\"border:2px solid gray;\">כמות חניכים כוללת:" + totalAmount + "<br> היו: <font color=\"ForestGreen\">" + dates[k].yes + "</font>\nנעדרו: <font color=\"red\">" + dates[k].no + "<br></font><span id='Activity'+k>Activity  "+k+" details:<span>";
            }
            html += "</tr>";

            //alert("created html:" + html);
            try 
            {
                part = JSON.parse(json2);
                //alert("understood json for /getParticipation")

                var members = new Array();
                var memberInsideAlready = new Array();

                $('#myMembers tbody tr').remove();

                //alert("compare to each of the "+part.length+" participants' dates to show participation for each...");
                for (p = 0; p < part.length; p++)
                {
                    var currName = part[p].member;
                    
                    html += "<tr><th class=\"straight\"><div><span></span></div></th>";
                
                    html += "<tr>";
                    html += "<th>"+currName+" ("+(p+1)+")</th>";

                    var columnsCount = 0;
                    // go over all available dates (table columns)
                    for (var cols = dates.length - 1; cols > -1; cols--)
                    {
                        var currDate = dates[cols];
                        var dateAvailable = false;
                        var dateIndex = -1;

                        var datesCount = dates.length;


                        // compare them to the dates returned from prticipation table to un\check them...
                        for (var dateInd = part[p].dates.length - 1; dateInd > -1; dateInd--)
                        {
                            if (part[p].dates[dateInd].date == currDate.date) 
                            {
                                dateIndex = dateInd;
                                dateAvailable = true;
                            }
                        }
                        if ( dateAvailable )
                        {
                            html += "<td><center><input type=\"checkbox\"";
                            html += part[p].dates[dateIndex].participated ? "checked=\"checked\"": "";
                            html += " disabled></center></td>"; 
                            columnsCount++;
                        } 
                        else
                        {
                            html += "<td><center>X</center></td>";
                            columnsCount++;
                        }
                    }
                    for (var missing = columnsCount; missing < datesCount; missing++)
                    {
                        //html += "<td>X</td>";
                    }

                    html += "</tr>";
                    //alert("created html for users!");
                }
                document.getElementById("myMembers").innerHTML = "<table id=\"partTable\">"+html+"</table>";    
                document.getElementById("createbutt").style.visibility = "visible";
            }
            catch (e)
            {
                alert("exception 8:"+e);
            }
         });
         

    });
}

var ActivityHTMLs = new Array();

async function drawActivityDetails()
{
    //don't loop!: getMembersToClient(userId);
    
    var k = 0;
    for (k = 0; k < datesArr.length; k++)
    {
        var dateObj = datesArr[k];
        $.get("/getActivity?instID="+instID+"&date=" + dateObj.date, "", function (actJson)
        {    
            activity = JSON.parse(actJson);
            activityHtml = "נושא הפעולה:"  +activity.Name+ "<br> סוג: <font color=\"ForestGreen\">"+activity.type+"</font><br>הערות: <font color=\"ForestGreen\">"+ activity.subtype + "</font>";
            ActivityHTMLs[ActivityHTMLs.length] = activityHtml;
            
            k++;
        });    
    }
}

function ObjNum(obj, arr)
{
    for (i = 0; i < arr.length; i++)
    {
        if (arr[i].name == obj)
            return i;
    }
    return -1;
}

function addActDescription()
{
    alert(0);
    for (i = 0; i < datesArr.length; i++)
{
    document.getElementById("Activity"+i).innerHTML = ActivityHTMLs[i];
}}

function ObjInArray(obj, arr)
{
    for (i = 0; i < arr.length; i++)
    {
        if (arr[i] == obj)
            return true;
    }
    return false;
}

function createNew()
{
    var selecteduser = "";

    if (document.getElementById("myMembers").rows.length <= 2) return;
    var sel = document.getElementById("rakazim");
    if (sel == null)
    {
        selecteduser = userId;
    }
    else
    {
        var selecteduser = sel.options[sel.selectedIndex].id;
    }
    window.location = "./newActivity.html?instid="+selecteduser;
}

function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

</script>
</head>
<body onload="sleep(1000); getUserDetails(); loadRakazim(); getMembersToClient(instID); window.setTimeout('addActDescription()', 1000);" dir="rtl">

    <div style="direction: rtl; height:170px; border:50px; border-width: 5px; border-style: solid; border-color: #4a90e2; background: #4a90e2;"><h1><img src="./style/סמל_קרמבו_חדש_עברית.jpg" alt="כנפים של קרמבו" style="width:120px; height:120px;"/>כנפים של קרמבו - אפליקציית 'השתתפות'
    </h1><br><div style="position: fixed; right: 150px;"><h3><img></div></span></h3></div>`
            
    <h2>רישום השתתפות של חניכים של <span id="instName"></span>  מסניף '<span id="branch"></span>'</h2>
    <br>
    <script language="javascript">
    document.write("<span id='rakazSelector'></span>");
    document.write("<span id='chooseInstructor'></span>");
    </script>
    
    
     
         <!-- used to be:'selector-->
        <hr>
        <table border=0 id="myMembers" >
                <tbody>
                    <tr>
                        <th></th>
                    </tr>
                    <tr>
                        <td></td>
                    </tr>

                    <hr>
                    
                    <button ID="createbutt" type="button" onclick="createNew()" STYLE="visibility: hidden">צור פעולה חדשה</button>

                    
                </tbody>
            </table>
    

    <script lang="=javascript">
       </script>
</body>

</html>