<html dir='rtl' lang='heb'>
    <head>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script language="javascript">

var urlParams = new URLSearchParams(location.search);
        var instID = urlParams.get("instID");
        var loggedUserId = -2;
        var admin = 0;
        var userName = "";
        var userId = -9;

        async function getUserDetails()
        {    
            $.get("/userName", function(json)
            {
                user = JSON.parse(json);
                userId = user.id;
                loggedUserId = user.id;
                userName = user.name;
                admin = user.admin;
                branch = user.Branch;

                //alert("user ''"+userName+"'' is "+(user.admin == 1? "": "NOT an ")+"admin!");
                document.getElementById("instNameHtml").innerHTML = userName;
                document.getElementById("branch").innerHTML = branch;
            });
        };

function loadRakazim()
            {
                $.get("/rakazim", "", function (json) 
                {
                    try 
                    {
                        var rakazimArray = JSON.parse(json);
                        loadData(rakazimArray);
                    }
                    catch(e)
                    {
                        //alert(e);
                    }
                });
            }


    function getMembers(inst)
    {
        $.get("/membersForInstructor?instID="+inst, function (json2)
        {
            drawMembers(json2);
        });
    }

        function selectAll()
        {
            var boxes = $('*[id^="ID-"]');
            for (i = 0; i < boxes.length; i++)
            {
                boxes[i].checked = !boxes[i].checked;
            }
        }

        function drawMembers(json2)
        {
            var membersHtml = "<table><tr><th>אקטיבי?</th><th>שם</tr><form id=\"form1\" action=\"/editMembers\" method=\"get\">";

            try 
            {
                sleep(1000);
                var members = JSON.parse(json2);


                members.forEach(m => 
                {
                    membersHtml += `<tr><td><input id="ID-`+m.memberID + `"" name="ID-`+m.memberID+`" type="checkbox" onclick="setChangeVars(this.id)" `+(m.Active == "1"? "checked": "")+`></td><td>`+(m.Active == "1"?"": "<font color='red'>")+m.name+(m.Active == "1"?"":"</font>")+`</td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>`;
                });
                membersHtml += "</table><br>";
                document.getElementById("membersTable").innerHTML = "";
                document.getElementById("membersTable").innerHTML = membersHtml;
                //document.getElementById("submitButt").style.visibility = "visible";
            }
            catch(e)
            {
                alert(e);
            }     
        }
            var changedVars = "";

            function setChangeVars(checkId)
            {
                var chk = document.getElementById(checkId);
                /*if (chk.checked) 
                {
                    alert("לא ניתן להשתמש בדף זה כדי לסמן חניך חזרה כאקטיבי! בצע refresh כדי לחזור לראות מצב אקטיביות נוכחי, או בקש מאדמיניסטרטור של המערכת להפוך חניכים חזרה לאקטיביים, אם יש בכך צורך.");
                    chk.checked = false;
                    return;
                }*/
                var loc = changedVars.indexOf(chk.id);
                if (loc > 0)
                {
                    var loc2 = changedVars.indexOf("&", loc);
                    changedVars = changedVars.substring(0, loc) + changedVars.substring(loc2);
                }
                else
                {
                    if (changedVars.length > 0) changedVars += "&";
                    changedVars += chk.id + "=" + chk.checked;
                }
            
                // now set color to match...(black\red)
                var rightColor = (chk.checked ? "black": "red");
                chk.parentNode.nextSibling.style.color = rightColor;
            }
 
            async function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            async function instName()
            {
                await getUserDetails();
                await sleep(1000);
                if (admin < 1)
                {
                    if (instID != loggedUserId)
                    {
                        document.getElementById("wait").remove();
                        document.write(`<img class="irc_mi" src="https://icon2.cleanpng.com/20180619/klp/kisspng-confined-space-warning-sign-hazard-sticker-no-entrance-5b29cebf79ccf9.8924609915294665594989.jpg" width="260" height="260">`)
                        await sleep(1000);
                        alert("אינך יכול/ה לצפות בנתוני מדריך אחר מבלי לעשות מחדש לוגין בעזרת שם המשתמש שלו (או שלה)! :-)");
                        return;
                    }
                }
                alertInst(userId);
                
                
            }





            function alertInst()
            {
                document.getElementById("instNameHtml").textContent = userName;
                document.getElementById("branch").textContent = branch;
                getMembers(instID);
            }

            async function deactivateMembers()
            {
                await deactivateOnServer();
                alert("בחירתך נשמרה...");
            }

            async function deactivateOnServer()
            {
                var url = "/deactivateUsers?" + changedVars;
                var res = "";
                try
                {
                    $.get(url, function (retSon) 
                    {
                        alert("done: "+retSon); 
                        alert('reloading...'); 
                    });
                    
                    
                }
                catch (e) 
                {
                    alert(e);
                }                
                
            }
</script>

</head>
<body onLoad="instName();">

    <input type="text" style="visibility: hidden" name="InstructorID" id="InstructorID"><h3>
    החניכים של המדריך '<span id="instNameHtml"></span> (מסניף '<span id='branch'></span>'):</h3><br>
<button id="selAll" type="button" onclick="selectAll()" value=""> הפוך את הבחירה בכווווווולם! (כפתור שיעוף מפה)</button>
    <div id="membersTable"><img id="wait" src='/html/wait.gif'></div>
    <br><br></br></br><hr>
    <button id='await' type="button" onclick="deactivateMembers();">שמור בחירה!</button>

     
</body>
</html>