<html dir='rtl' lang='heb'>
    <head>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script language="javascript">

var urlParams = new URLSearchParams(location.search);
        var instID = urlParams.get("instID");
        var loggedUserId = -2;
        var instructor = "";
        var admin = 0;
        var userName = "";
        var userId = -9;

        async function getUserDetails()
{    
    $.get("/userName", "", function(json)
    {
        user = JSON.parse(json);
        userId = user.id;
        loggedUserId = user.loggedUser;
        userName = user.name;
        admin = user.admin;
        district = user.district;

        //alert("user ''"+userName+"'' is "+(user.admin == 1? "": "NOT an ")+"admin!");
        document.getElementById("instNameHtml").innerHTML = userName;
        //if (admin == 1) loadRakazim();
        //else alert("you are NOT marked as 'admin' user thus cannot view this page...");
        document.getElementById("branch").innerHTML = district;
    });
};

function loadRakazim()
            {
                $.get("/rakazim", "", function (json) 
                {
                    try 
                    {
                        var rakazimArray = JSON.parse(json);
                        loadData(rakazimArray);
                    }
                    catch(e)
                    {
                        //alert(e);
                    }
                });
            }


    function getMembers(inst)
    {
        $.get("/membersForInstructor?instID="+inst, function (json2)
        {
            drawMembers(json2);
        });
    }

        function selectAll()
        {
            var boxes = $('*[id^="ID-"]');
            for (i = 0; i < boxes.length; i++)
            {
                boxes[i].checked = !boxes[i].checked;
            }
        }

        function drawMembers(json2)
        {
            var membersHtml = "<table><tr><th>אקטיבי?</th><th>שם</tr><form id=\"form1\" action=\"/editMembers\" method=\"get\">";

            try 
            {
                var members = JSON.parse(json2);


                members.forEach(m => 
                {
                    membersHtml += "<tr><td><input id=\"ID-"+m.memberID+"\" name=\"ID-"+m.memberID+"\" type=\"checkbox\" onclick=\"setChangeVars('ID-"+m.memberID+"')\" checked></td><td>"+m.name+"</td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>";
                });
                membersHtml += "</table><br>";
                document.getElementById("membersTable").innerHTML = "";
                document.getElementById("membersTable").innerHTML = membersHtml;
                //document.getElementById("submitButt").style.visibility = "visible";
            }
            catch(e)
            {
                alert(e);
            }     
        }
            var changedVars = "";

            function setChangeVars(checkId)
            {
                var chk = document.getElementById(checkId);
                var loc = changedVars.indexOf(chk.id);
                if (loc > 0)
                {
                    var loc2 = changedVars.indexOf("&", loc);
                    changedVars = changedVars.substring(0, loc) + changedVars.substring(loc2);
                }
                else
                {
                    if (changedVars.length > 0) changedVars += "&";
                    changedVars += chk.id + "=" + chk.checked;
                }

            }
 
            function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

            async function instName(instructorID)
            {
                await sleep(3000);
                document.getElementById("InstructorID").value = instructorID;
                if (admin < 1)
                {
                    if (loggedUserId == -2) await getUserDetails();
                    if (instID != loggedUserId)
                    {
                        alert("You CANNOT watch other instructor unless you login with his credentials!");
                        return;
                    }
                }
                alertInst(instructorID);
                
                
            }





            function alertInst(instructor)
            {
                document.getElementById("instNameHtml").textContent = userName;
                document.getElementById("branch").textContent = district;
                getMembers(instID);
            }

            function deactivateMembers()
            {
                var url = "/deactivateUsers?" + changedVars;
                var res = "";
                msg = $.get(url, function (json2) 
                {
                    debugger;
                    alert(json2);
                });
                location.reload();
                
            }
</script>

</head>
<body onLoad="getUserDetails(); instName(instID);">

    <input type="text" style="visibility: hidden" name="InstructorID" id="InstructorID">

        החניכים של המדריך: '<span id="instNameHtml"></span> (מסניף '<span id='branch'></span>'):<br>
<button id="selAll" type="button" onclick="selectAll()" value="">הפוך את הבחירה בכווווווולם!</button>
    <div id="membersTable"><img src='/html/tenor.gif'></div>
    <br><br></br></br><hr>
    <button id='deactivateMembers' type="button" onclick="deactivateMembers()" value="">הפוך חניכים ל'לא אקטיביים'!</button>

     
</body>
</html>