<html lang='heb' dir='rtl'>

<head>
        <style>
                th.rotate 
                {
                  /* Something you can count on */
                  height: 160px;
                  white-space: nowrap;
                }
                
                th.rotate > div 
                {
                  transform: 
                    /* Magic Numbers */
                    translate(55px, 5px)
                    
                    /* 45 is really 360 - 45 */
                    rotate(315deg);
                  width: 30px;
                }
                th.rotate > div > span 
                {
                  border-bottom: 1px solid #ccc;
                  padding: 0px 30px;
                }
                </style>
                
    
                <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
                <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
                            
<script language="javascript">
var instID = -1;
var loggedUser = "";
var instructor = "";
var admin = 0;
var userName = "";
var branch = "";
var userId = -9;

function urlVar(name)
{
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);    
}
var loginGood = false;

async function getUserDetails(ID)
{
    if (ID === undefined) ID = instID;

    $.get("/userDetails?ID="+ID, "", function(json)
    {
        user = JSON.parse(json); 
        loggedUser = user.loggedUser;
        instID = user.id;
        userName = user.name;
        document.getElementById("instName").innerHTML = userName;
        document.getElementById("branch").innerHTML = user.branch;

        if (user.loggedUser == user.id)
        {
            loginGood = true;
            window.setTimeout(`drawAfterValidation()`, 500);
        }
        else
        {
            loginGood = false;
            alert("You CANNOT watch other instructor unless you login with his credentials!");
            document.getElementById("htmlAll").innerHTML = `<img class="irc_mi" src="https://icon2.cleanpng.com/20180619/klp/kisspng-confined-space-warning-sign-hazard-sticker-no-entrance-5b29cebf79ccf9.8924609915294665594989.jpg" alt="Image result for no entrance sign" width="260" height="260" style="">`;
            return;   
        }
        

        return userName;
    });

}
var html = "";

var doneUserDetails = false;

async function getMyUserDetails()
{    
    if (doneUserDetails) return;
    var myMembers = document.getElementById("myMembers");
    $.get("/getInstDates?instID="+instID, "", function (datesJson)
    {    
        dates = JSON.parse(datesJson);

        if (dates.length == 0)
        {
            // notify that there are NO activities for that instructor...
            html = `אין לך עדיין פעילויות שנרשמו במערכת! <b>ביכולתך ליצור פעולה חדשה ע"י לחיצה על כפתור היצירה מתחת</b>...`;
        }
        // first add dates as headers
        if (typeof(dates) != "undefined" && dates.length > 0)
        {
            for (p = dates.length - 1; p > -1; p--)
            {
                html += `<th class="rotate"><div><span><a id='date+${p}+' href='./editActivity.html?instid=${instID}&date=${dates[p].date}'>${dates[p].date}</a></span></div></th>`;
            }
            html += "<th class=\"rotate\"><div>";

            // add totals records BEFORE actual listings
            html += "<tr><td></td>";
            for (var o = dates.length - 1; o > -1; o--)
            {
                //var activityHtml = "<span dir='rtl' id='act"+o+"Description'>"+o+"</span>";
                var activityHtml = "<span dir='rtl' id='act"+o+"Description'>?"+o+"</span>";
                
                $.get("/getActivity?instID=" + instID + "&date=" + dates[o].date + "&point=" + o, "", (actJson) => 
                {
                    activity = JSON.parse(actJson);

                    window.setTimeout(`linkFixer(${activity.point}, ${activity.id})`, 1000);
                    subtype = activity.subtype;
                    if (subtype == "") subtype = "אין";
                    activityHtml = "<b>נושא הפעולה:</b><br>" + activity.Name + 
                                        "<br> <b>סוג:</b> <br><font color=\"ForestGreen\">" + 
                                        activity.type + "</font><br><b>הערות:</b> <br><font color=\"ForestGreen\">" + 
                                            subtype + "</font>";

                    //var pointerIndex = html.indexOf("?"+activity.point);
                    //var secondPart = html.substr(pointerIndex + 2);
                    //var firstPart = html.substr(0, pointerIndex);
                    //html = firstPart + activityHtml + secondPart;

                    window.setTimeout(`writeActDescription(${activity.point}, encodeURI(\`${activityHtml}\`))`, 20000);
                });
                var totalAmount = Number(dates[o].yes) + Number(dates[o].no);

                // get activity details:
                var yes = dates[o].yes;
                var no = dates[o].no;
                html += "<td style=\"border:2px solid gray;\">כמות חניכים כוללת:" + totalAmount + "<br> היו: <font color=\"ForestGreen\">" + yes + "</font><br>נעדרו: <font color=\"red\">" + dates[o].no + "<br></font><span dir='ltr' id='Activity'+k><br>"+activityHtml+"<span>";
            }
        }
        else
        {
            
        }
        html += "</tr>";

        //document.write(html);            
    });

    var url = "/getParticipation?instID="+instID;
    html = "<th class=\"straight\"><div><span></span></div></th>";

    $.get(url, "", function (json2) 
    {
        try 
        {
            part = JSON.parse(json2);
            

            var members = new Array();
            var memberInsideAlready = new Array();

            //$('#myMembers tbody tr').remove();

            
            for (p = 0; p < part.length; p++)
            {
                var currName = part[p].member;
                
                html += "<tr><th class=\"straight\"><div><span></span></div></th>";
            
                html += "<tr>";
                html += "<th";
                /*
                if(typeof(part[p].dates[p].participated != "undefined") && pnoteart[p].dates[p].participated)
                {
                    html += ` style="color: green"`;
                }
                else
                {
                    html += ` style="color: red"`;
                }
                */
                html += ">"+(p+1)+". "+currName+"</th>";

                var columnsCount = 0;
                // go over all available dates (table columns) if they exist
                if (typeof(dates) == "undefined")
                cols = -1;
                else
                cols = dates.length - 1;
                for (i= cols ; i > -1; i--)
                {
                    var currDate = dates[i];
                    var dateAvailable = false;
                    var dateIndex = -1;

                    var datesCount = dates.length;


                    // compare them to the dates returned from prticipation table to un\check them...
                    for (var dateInd = part[p].dates.length - 1; dateInd > -1; dateInd--)
                    {
                        dateAvailable = false;
                        if (part[p].dates[dateInd].date == currDate.date) 
                        {
                            dateIndex = dateInd;
                            dateAvailable = true;
                            break;
                        }
                    }
                    if ( dateAvailable )
                    {
                        if(part[p].dates[dateIndex].participated)
                        {
                            html += "<td><center><input type=\"checkbox\"";
                            html += part[p].dates[dateIndex].participated ? "checked=\"checked\"": "";
                            html += " disabled style=\"color: green\"></center></td>"; 
                            columnsCount++;
                        }
                        else
                        {
                            html += "<td><center>X</center></td>";
                        }
                    } 
                    else
                    {
                        html += "<td><center>X</center></td>";
                        columnsCount++;
                    }
                }
                for (var missing = columnsCount; missing < datesCount; missing++)
                {
                    //html += "<td>X</td>";
                }

                html += "</tr>";
                
            }
            myMembers.innerHTML = "<table id=\"partTable\">"+html+"</table>";    
            //myMembers.innerHTML = html;
            //document.getElementById("createbutt").style.visibility = "visible";
        }
        catch (e)
        {
            alert("exception 8:"+e);
        }        
    });
    doneUserDetails = true;
};

    function linkFixer(point, ActivityID)
   {
        
        //window.setTimeout(`document.getElementById("date+${point}+").setAttribute('href', "./editActivity.html?act="+ActivityID)`, 500);
   }
    
    async function loadData(rakazimArray)
    {
 
        // normal user
        await getMembersToClient(userId);
     
        var elem = document.getElementById("chooseInst");
    }

var part;
var partByMembers = new Array();


var dates;

//
// הצג את החניכים של מדריך זה בטבלת השתתפות!
//
async function getMembersToClient(instID)
{
    
            

    //alert("created html:" + html);

}

function writeActDescription(descrNum, descr)
{
    var descrLoc = document.getElementById("act"+descrNum+"Description");
    descrLoc.innerHTML = decodeURI(descr);
}
var ActivityHTMLs = new Array();


function ObjNum(obj, arr)
{
    for (i = 0; i < arr.length; i++)
    {
        if (arr[i].name == obj)
            return i;
    }
    return -1;
}


function ObjInArray(obj, arr)
{
    for (i = 0; i < arr.length; i++)
    {
        if (arr[i] == obj)
            return true;
    }
    return false;
}

function createNew()
{
    var selecteduser = "";

    //if (document.getElementById("myMembers").rows.length <= 2) return;
    var sel = document.getElementById("rakazim");
    if (sel == null)
    {
        selecteduser = instID;
    }
    else
    {
        var selecteduser = sel.options[sel.selectedIndex].id;
    }
    window.location = "./newActivity.html?instid="+selecteduser;
}

async function initOnLoad()
{
    instID = new URLSearchParams(window.location.search).get("instID");
    await getUserDetails(instID);
    {
    }
}
async function drawAfterValidation()
{
    await getMyUserDetails();
    while (instID == -9) sleep(3000); 
    await loadData("[]");

}

function sleep2(ms)
{
    var start = new Date().getTime(); 
    while( ms > ( new Date().getTime() - start ) ){} 
}
function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

</script>
</head>
<body onload="initOnLoad(); getUserDetails();" dir="rtl">

    
        <table style="border:50px; border-width: 5px; border-style: solid; border-color: #4a90e2; background: #4a90e2;">
            <tr><td><img src="./style/סמל_קרמבו_חדש_עברית.jpg" alt="כנפים של קרמבו" style="width:120px; height:120px;"/>
            </td><td><h1>כנפים של קרמבו - אפליקציית 'השתתפות'</td></h1><br>
        </tr>
        </table>
                    
    <h2>רישום השתתפות של חניכים של <span id="instName"></span>  מסניף '<span id="branch"></span>'</h2>
    <br>
    <script language="javascript">
    document.write("<span id='rakazSelector'></span>");
    document.write("<span id='chooseInstructor'></span>");
    </script>
    
    
     
         <!-- used to be:'selector-->
        <hr>
        
        <table border=0 id="myMembers">
                    <tr>
                        <th></th>
                    </tr>
                    <tr>
                        <td></td>
                    </tr>
        </table><br>
                    <hr>
                    
                    <input type="button" id="createbutt" onClick="createNew()" style="visibility: visible" value="צור פעולה חדשה"></input>
</body>

</html>