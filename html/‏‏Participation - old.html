<html lang='heb' dir='rtl'>

<head>
        <style>
                th.rotate 
                {
                  /* Something you can count on */
                  height: 160px;
                  white-space: nowrap;
                }
                
                th.rotate > div 
                {
                  transform: 
                    /* Magic Numbers */
                    translate(55px, 5px)
                    
                    /* 45 is really 360 - 45 */
                    rotate(315deg);
                  width: 30px;
                }
                th.rotate > div > span 
                {
                  border-bottom: 1px solid #ccc;
                  padding: 0px 30px;
                }
                </style>
                
    
                <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
                <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

<script language="javascript">
var instID = -1;
var instructor = "";
var admin = 0;
var userName = "";
var district = "";
var userId = -9;



async function getUserDetails(ID)
{
    $.get("/userDetails?ID="+ID, "", async function(json)
    {
        user = JSON.parse(json);
        return user.name;
    });

}
async function getMyUserDetails()
{    
    $.get("/userName", "", function(json)
    {html += "</tr>";
        user = JSON.parse(json);
        userId = user.id;
        instID = Instructor = user.id;
        userName = user.name;
        admin = user.admin;
        district = user.district;

        if (admin == "1")
        {
            //loadRakazim();
            document.getElementById("rakazSelector").innerHTML = "<div id=\"chooseInst\">בחר רכז: <span id=\"selector\">?</span></div>";
            //document.getElementById("rakazSelector").innerHTML = "<h3>";
            //document.getElementById("chooseInstructor").innerHTML = `<div id="chooseInst">רכז: <span id="selector"></span></div>`;
        }
        //alert("user ''"+userName+"'' is "+(user.admin == 1? "": "NOT an ")+"admin!");
        document.getElementById("selector").innerHTML = userName;
        document.getElementById("branch").innerHTML = district;
        //document.getElementById("instNameHtml").innerHTML = userName;

    });
};
    
    async function loadRakazim() 
    {    
        //if (instID.length < 1)

        if (userId != -9)
        {
            instName(userId);
            //loadData(instID);
            await getMembersToClient(userId);
            html = instructor;

            $("#currentUser").replaceWith(html);
        }
        else
        {
            $.get("/rakazim", "", function (json) 
            {
                try 
                {
                    var rakazimArray = JSON.parse(json);
                    loadData(rakazimArray);
                }
                catch(e)
                {
                    //alert(e);
                }
                // delete:
                //loadData(rakazimArray);
            });
        }
    }
    
    async function loadData(rakazimArray)
    {
        if (admin == "1")
        {
            // admin user! show ALL rakazim...
            var html = `<select id="rakazim" onChange="getMembersToClient(this.options[this.selectedIndex].getAttribute('id'))">`;
    
            $.each(rakazimArray, function (i, value) 
            {
                html += `<option id="${rakazimArray[i].id}" value="${rakazimArray[i].Name}">${rakazimArray[i].Name}</option>`;
            });
            html += "</select>";

        }
        else
        {
            // normal user
            instName(userId);
            await getMembersToClient(userId);
            html = "<input type=\"text\" value=\"" + instructor + "\">";

            $("#rakazim").innerHTML = html;
        }

        //document.getElementById("selector").innerHTML = html;

        if (admin != 1)
        {
            var elem = document.getElementById("chooseInst");
            //elem.parentNode.removeChild(elem);
        }
    }

var part;
var partByMembers = new Array();

function instName(ID)
{
    getUserDetails(ID);
    document.getElementById("instName").innerHTML = userName;
    $("#rakazim").innerHTML = userName;
}

var dates;

//
// הצג את החניכים של מדריך זה בטבלת השתתפות!
//
async function getMembersToClient(instID)
{
    var url = "/getParticipation?instID="+instID;
    var html = "<th class=\"straight\"><div><span></span></div></th>";

    $.get(url, "", async function (json2) 
    {
        //alert(json2);
        //alert("got participation for "+instID);
        
        $.get("/getInstDates?instID="+instID, "", async function (datesJson)
        {    
            dates = JSON.parse(datesJson);
            
            //let activities = await getActivityDetails(dates);
            //if (activities === undefined) activities = ["אין!"];
            
            // first add dates as headers
            //alert("for each one of the "+dates.length+" dates of that instructor...");
            if (typeof(dates) != "undefined" && dates.length > 0)
            {
                for (p = dates.length - 1; p > -1; p--)
                {
                    html += "<th class=\"rotate\"><div><span>"+dates[p].date+"</span></div></th>";
                }
                html += "<th class=\"rotate\"><div><tbody></tbody>";

                // add totals records BEFORE actual listings
                html += "<tr><td></td>";
                for (var o = dates.length - 1; o > -1; o--)
                {
                    var activityHtml = "<span dir='rtl' id='act"+o+"Description'>?"+o+"</span>";
                    var orgPointer = activityHtml;
                    instName(instID);
                    $.get("/getActivity?instID=" + instID + "&date=" + dates[o].date + "&point=" + o, "", (actJson) => 
                    {
                        activity = JSON.parse(actJson);
                        if (activity.point == "8") debugger;
                        activityHtml = "<b>נושא הפעולה:</b><br>" + activity.Name + 
                                            "<br> <b>סוג:</b> <br><font color=\"ForestGreen\">" + 
                                            activity.type + "</font><br><b>הערות:</b> <br><font color=\"ForestGreen\">" + 
                                            activity.subtype + "</font>";

                        //var pointerIndex = html.indexOf("?"+activity.point);
                        //var secondPart = html.substr(pointerIndex + 2);
                        //var firstPart = html.substr(0, pointerIndex);
                        //html = firstPart + activityHtml + secondPart;

                        window.setTimeout(`writeActDescription(${activity.point}, "${encodeURI(activityHtml)}")`, 5000);
                    });
                    var totalAmount = Number(dates[o].yes) + Number(dates[o].no);

                    // get activity details:
                    var yes = dates[o].yes;
                    html += "<td style=\"border:2px solid gray;\">כמות חניכים כוללת:" + totalAmount + "<br> היו: <font color=\"ForestGreen\">" + yes + "</font><br>נעדרו: <font color=\"red\">" + dates[o].no + "<br></font><span dir='ltr' id='Activity'+k><br>"+activityHtml+"<span>";
                }
            }
        });

            html += "</tr>";

            //document.write(html);
            //alert("created html:" + html);
            try 
            {
                part = JSON.parse(json2);
                //alert("understood json for /getParticipation")

                var members = new Array();
                var memberInsideAlready = new Array();

                $('#myMembers tbody tr').remove();

                //alert("compare to each of the "+part.length+" participants' dates to show participation for each...");
                for (p = 0; p < part.length; p++)
                {
                    var currName = part[p].member;
                    
                    html += "<tr><th class=\"straight\"><div><span></span></div></th>";
                
                    html += "<tr>";
                    html += "<th>"+(p+1)+". "+currName+"</th>";

                    var columnsCount = 0;
                    // go over all available dates (table columns) if they exist
                    if (typeof(dates) == "undefined")
                    cols = -1;
                    else
                    cols = dates.length - 1;
                    for (i= cols ; i > -1; i--)
                    {
                        var currDate = dates[i];
                        var dateAvailable = false;
                        var dateIndex = -1;

                        var datesCount = dates.length;


                        // compare them to the dates returned from prticipation table to un\check them...
                        for (var dateInd = part[p].dates.length - 1; dateInd > -1; dateInd--)
                        {
                            if (part[p].dates[dateInd].date == currDate.date) 
                            {
                                dateIndex = dateInd;
                                dateAvailable = true;
                            }
                        }
                        if ( dateAvailable )
                        {
                            html += "<td><center><input type=\"checkbox\"";
                            html += part[p].dates[dateIndex].participated ? "checked=\"checked\"": "";
                            html += " disabled></center></td>"; 
                            columnsCount++;
                        } 
                        else
                        {
                            html += "<td><center>X</center></td>";
                            columnsCount++;
                        }
                    }
                    for (var missing = columnsCount; missing < datesCount; missing++)
                    {
                        //html += "<td>X</td>";
                    }

                    html += "</tr>";
                    //alert("created html for users!");
                }
                document.getElementById("myMembers").innerHTML = "<table id=\"partTable\">"+html+"</table>";    
                document.getElementById("createbutt").style.visibility = "visible";
            }
            catch (e)
            {
                alert("exception 8:"+e);
            }
         
         

    });
}

function writeActDescription(descrNum, descr)
{
    var descrLoc = document.getElementById("act"+activity.point+"Description");
    descrLoc.innerHTML = descr;

}
var ActivityHTMLs = new Array();


function ObjNum(obj, arr)
{
    for (i = 0; i < arr.length; i++)
    {
        if (arr[i].name == obj)
            return i;
    }
    return -1;
}


function ObjInArray(obj, arr)
{
    for (i = 0; i < arr.length; i++)
    {
        if (arr[i] == obj)
            return true;
    }
    return false;
}

function createNew()
{
    var selecteduser = "";

    if (document.getElementById("myMembers").rows.length <= 2) return;
    var sel = document.getElementById("rakazim");
    if (sel == null)
    {
        selecteduser = userId;
    }
    else
    {
        var selecteduser = sel.options[sel.selectedIndex].id;
    }
    window.location = "./newActivity.html?instid="+selecteduser;
}

async function initOnLoad()
{
    await getMyUserDetails(); 
    await loadRakazim(); 
}
function sleep2(ms)
{
    var start = new Date().getTime(); 
    while( ms > ( new Date().getTime() - start ) ){} 
}
function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

</script>
</head>
<body onload="alert(0); initOnLoad();" dir="rtl">

    <div style="direction: rtl; height:170px; border:50px; border-width: 5px; border-style: solid; border-color: #4a90e2; background: #4a90e2;"><h1><img src="./style/סמל_קרמבו_חדש_עברית.jpg" alt="כנפים של קרמבו" style="width:120px; height:120px;"/>כנפים של קרמבו - אפליקציית 'השתתפות'
    </h1><br><div style="position: fixed; right: 150px;"><h3><img></div></span></h3></div>`
            
    <h2>רישום השתתפות של חניכים של <span id="instName"></span>  מסניף '<span id="branch"></span>'</h2>
    <br>
    <script language="javascript">
    document.write("<span id='rakazSelector'></span>");
    document.write("<span id='chooseInstructor'></span>");
    </script>
    
    
     
         <!-- used to be:'selector-->
        <hr>
        <table border=0 id="myMembers" >
                <tbody>
                    <tr>
                        <th></th>
                    </tr>
                    <tr>
                        <td></td>
                    </tr>

                    <hr>
                    
                    <input type="button" id="createbutt" type="button" onclick="createNew()" style="visibility: hidden">צור פעולה חדשה</input>

                    
                </tbody>
            </table>

</body>

</html>